<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ú–∏—Å—Å–∏—è: –ö–∏–±–µ—Ä—â–∏—Ç | Mobile Optimized</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="preload" as="video" href="intro.mp4" type="video/mp4">
    <style>
        /* --- –°–¢–ò–õ–ò (OPTIMIZED) --- */
        :root {
            --neon-blue: #00f3ff;
            --neon-green: #0aff0a;
            --neon-red: #ff003c;
            --bg-color: #000000;
            --glass: rgba(10, 16, 26, 0.96);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; background-color: var(--bg-color); color: white;
            font-family: 'Orbitron', sans-serif; overflow: hidden; 
            height: 100dvh; width: 100vw; display: flex;
            align-items: center; justify-content: center; user-select: none;
        }

        #main-wrapper {
            display: flex; width: 100%; height: 100%;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            position: relative; overflow: hidden; transition: all 0.3s ease;
        }

        #game-viewport {
            position: absolute; inset: 0; background: #000;
            overflow: hidden; display: flex; flex-direction: column;
            width: 100%; height: 100%; z-index: 10;
            justify-content: center;
        }
        
        #click-trap {
            position: absolute; inset: 0; z-index: 45; 
            display: none; background: rgba(0,0,0,0.4); 
            backdrop-filter: blur(2px); cursor: pointer;
        }
        #click-trap.active { display: block; }

        /* –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –í–ò–î–ï–û –ü–û–î –ú–û–ë–ò–õ–¨–ù–´–ï */
        video { 
            width: 100%; 
            height: 100%; 
            display: none; 
            opacity: 0; 
            transition: opacity 0.4s; 
            background: #000; 
            transform: translateZ(0); 
            will-change: opacity;
            object-fit: cover; 
            object-position: center;
        }

        @media (orientation: portrait) {
            video {
                object-fit: contain; 
                width: 100%;
                height: 100%;
            }
        }

        video.playing { opacity: 1; display: block; }

        #game-viewport::after {
            content: " "; position: absolute; inset: 0;
            background: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none; z-index: 15;
            transition: opacity 0.3s;
        }
        #game-viewport.video-mode::after { opacity: 0; }

        #sim-layer {
            position: absolute; inset: 0; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            background: radial-gradient(circle at 50% 50%, #001a33 0%, #000 100%);
            z-index: 5; transition: opacity 0.5s;
        }
        #sim-layer.fade-out { opacity: 0; pointer-events: none; }
        
        .radar {
            width: 140px; height: 140px; border: 2px solid rgba(0, 243, 255, 0.5);
            border-radius: 50%; position: relative;
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.2); margin-bottom: 30px;
        }
        .radar::before {
            content: ''; position: absolute; top: 50%; left: 50%; width: 50%; height: 50%;
            background: linear-gradient(45deg, transparent 50%, rgba(0, 243, 255, 0.9) 100%);
            transform-origin: 0 0; animation: radar-spin 1.5s linear infinite;
        }
        @keyframes radar-spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

        #sim-text {
            font-family: 'Share Tech Mono', monospace; font-size: 1.1rem;
            letter-spacing: 4px; color: var(--neon-blue); animation: pulse 2s infinite alternate; text-align: center;
        }
        @keyframes pulse { 0% {opacity: 0.6;} 100% {opacity: 1;} }

        #side-menu {
            position: absolute; background: rgba(8, 12, 18, 0.98); border: 1px solid #333; 
            border-left: 3px solid var(--neon-blue); padding: 15px; 
            font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; 
            color: var(--neon-blue); overflow-y: auto; 
            display: flex; flex-direction: column-reverse; z-index: 1000; 
            transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px solid rgba(0,243,255,0.1); padding-bottom: 4px; }
        .log-warn { color: var(--neon-red); }
        .log-success { color: var(--neon-green); }

        .close-menu-btn {
            position: absolute; top: 10px; right: 10px;
            color: #666; cursor: pointer; padding: 5px; font-size: 1.5rem;
        }
        .close-menu-btn:hover { color: #fff; }

        #hud {
            position: absolute; top: 0; left: 0; right: 0; padding: 15px;
            display: flex; justify-content: space-between; z-index: 500;
            font-size: 0.8rem; font-weight: bold; pointer-events: none; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
        }
        .hud-left, .hud-right { display: flex; gap: 10px; pointer-events: auto; align-items: center; }
        .hud-item {
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 14px; border-radius: 30px; backdrop-filter: blur(10px); color: #ddd;
        }
        .icon-btn {
            background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255,255,255,0.3); color: #fff;
            cursor: pointer; font-size: 1.2rem; padding: 0; border-radius: 50%;
            width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; touch-action: manipulation;
        }
        .icon-btn:active { transform: scale(0.9); background: var(--neon-blue); color: #000; }

        #health-bar-container { width: 100px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        #health-bar-fill { width: 100%; height: 100%; background: var(--neon-green); transition: width 0.5s, background 0.5s; box-shadow: 0 0 10px var(--neon-green); }

        /* SCREENS */
        .overlay {
            position: absolute; inset: 0; background: var(--glass); 
            backdrop-filter: blur(15px); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 2000;
            text-align: center; padding: 20px; transition: opacity 0.3s;
        }
        .hidden { opacity: 0; pointer-events: none; visibility: hidden; }
        .overlay-content { width: 100%; min-height: 100%; padding-bottom: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        h1 { color: white; margin: 0 0 15px 0; font-size: clamp(1.8rem, 5vw, 3rem); text-transform: uppercase; font-weight: 800; letter-spacing: 2px; text-shadow: 0 0 20px var(--neon-blue); }
        .btn {
            background: linear-gradient(90deg, rgba(0,243,255,0.15), rgba(0,243,255,0.05)); 
            color: var(--neon-blue); border: 1px solid var(--neon-blue); border-left: 4px solid var(--neon-blue);
            padding: 18px 36px; font-family: 'Orbitron', sans-serif; font-size: 1rem; font-weight: 700;
            cursor: pointer; transition: 0.2s; text-transform: uppercase; margin: 10px; position: relative; 
            user-select: none; min-width: 220px; border-radius: 4px; touch-action: manipulation;
            box-shadow: 0 0 15px rgba(0,243,255,0.1);
        }
        .btn:active { transform: scale(0.95); background: var(--neon-blue); color: #000; }
        
        .btn-danger { border-color: var(--neon-red); color: var(--neon-red); border-left-color: var(--neon-red); background: linear-gradient(90deg, rgba(255,0,60,0.15), rgba(255,0,60,0.05)); }
        .btn-danger:active { background: var(--neon-red); color: white; }

        .info-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-left: 4px solid var(--neon-blue); padding: 25px; text-align: left; max-width: 600px; margin-bottom: 30px; font-size: 1.1rem; width: 95%; border-radius: 8px; line-height: 1.5; }

        #admin-panel { width: 100%; max-width: 700px; max-height: 60vh; background: rgba(0,0,0,0.7); border: 1px solid #444; overflow-y: auto; padding: 10px; font-family: 'Share Tech Mono', monospace; font-size: 0.85rem; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px; color: #888; border-bottom: 1px solid #444; position: sticky; top: 0; background: #080c12; }
        td { border-bottom: 1px solid #222; padding: 10px; color: #eee; }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--neon-blue); color: #000; padding: 10px 20px; border-radius: 20px; font-weight: bold; z-index: 5000; opacity: 0; transition: 0.3s; pointer-events: none; }

        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (orientation: portrait) {
            #main-wrapper { flex-direction: column; }
            #side-menu { bottom: 0; left: 0; right: 0; height: 40vh; border-top: 2px solid var(--neon-blue); border-left: none; transform: translateY(105%); }
            #side-menu:not(.collapsed) { transform: translateY(0); }
            .btn { width: 90%; }
            #hud { padding-top: max(20px, env(safe-area-inset-top)); }
        }
        @media (orientation: landscape) {
            #main-wrapper { padding: 0 !important; }
            #game-viewport { width: 100vw; height: 100vh; position: fixed; inset: 0; }
            #side-menu { top: 0; left: 0; bottom: 0; width: 340px; border-right: 2px solid var(--neon-blue); border-left: none; transform: translateX(0); }
            #side-menu.collapsed { transform: translateX(-105%); }
            #side-menu:not(.collapsed) { transform: translateX(0); }
            .overlay-content { flex-direction: column; }
            #choice-buttons { flex-direction: row; }
            h1 { font-size: 3rem; }
            .btn { padding: 16px 32px; width: auto; min-width: 200px; margin: 10px 20px; }
            #hud { padding: 20px 40px; }
        }
    </style>
</head>
<body>
    
    <div id="toast">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>

    <div id="main-wrapper">
        <div id="click-trap" onclick="window.UI.toggleTerminal()"></div>

        <div id="side-menu" class="collapsed">
            <div class="close-menu-btn" onclick="window.UI.toggleTerminal()">&#10005;</div>
            <div class="log-entry log-info">> –ó–∞–≥—Ä—É–∑–∫–∞ —è–¥—Ä–∞ —Å–∏—Å—Ç–µ–º—ã v9.0...</div>
            <div class="log-entry log-info">> –°–±–æ—Ä–∫–∞ –º–æ–¥—É–ª–µ–π... OK</div>
            <div class="log-entry log-info">> –û–∂–∏–¥–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</div>
        </div>

        <div id="game-viewport">
            <video id="video-layer" playsinline webkit-playsinline preload="auto" muted style="background:transparent;"></video>
            
            <div id="sim-layer">
                <div class="radar"></div>
                <h2 id="sim-text">–ó–ê–ì–†–£–ó–ö–ê –ü–û–¢–û–ö–ê...</h2>
            </div>

            <div id="hud" class="hidden">
                <div class="hud-left">
                    <button class="icon-btn" id="btn-fullscreen" onclick="window.UI.toggleFullscreen()" title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω">üì∫</button>
                    <button class="icon-btn" id="btn-logs" onclick="window.UI.toggleTerminal()" title="–õ–æ–≥–∏">&#9776;</button>
                    <div class="hud-item">üõ°Ô∏è <div id="health-bar-container"><div id="health-bar-fill"></div></div></div>
                </div>
                <div class="hud-right">
                    <div class="hud-item"><span id="user-name-display">GUEST</span></div>
                    <div class="hud-item" style="color:var(--neon-blue)">üí† <span id="score-val">0</span></div>
                </div>
            </div>

            <div id="start-screen" class="overlay">
                <div class="overlay-content">
                    <h1>CYBERSHIELD</h1>
                    <h2 style="font-size: 0.9rem; letter-spacing: 5px; color:var(--neon-blue); margin-bottom:30px;">GRANDMASTER EDITION</h2>
                    <input type="text" id="username-input" placeholder="–ò–ú–Ø –ê–ì–ï–ù–¢–ê" maxlength="12"
                           style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); padding: 15px; color: white; font-family: inherit; margin-bottom: 30px; text-align: center; width: 280px; font-size: 1.2rem; border-radius: 6px; outline: none; letter-spacing: 2px; text-transform: uppercase;">
                    <button class="btn" onclick="window.Game.init()">üöÄ –ó–ê–ü–£–°–ö –°–ò–°–¢–ï–ú–´</button>
                    <button class="btn" style="border-color: rgba(255,255,255,0.3); color: #aaa; background: transparent;" onclick="window.Stats.show()">üìä –ê–†–•–ò–í</button>
                </div>
            </div>

            <div id="stats-screen" class="overlay hidden">
                <div class="overlay-content">
                    <h1>–ê–†–•–ò–í –ú–ò–°–°–ò–ô</h1>
                    <div id="admin-panel">
                        <table id="stats-table"><thead><tr><th>–í–†–ï–ú–Ø</th><th>–ê–ì–ï–ù–¢</th><th>–°–ß–ï–¢</th><th>–ò–¢–û–ì</th></tr></thead><tbody></tbody></table>
                    </div>
                    <div style="margin-top: 30px;">
                        <button class="btn" onclick="window.Stats.hide()">–ù–ê–ó–ê–î</button>
                        <button class="btn btn-danger" onclick="window.Stats.clearLocal()">–û–ß–ò–°–¢–ò–¢–¨</button>
                    </div>
                </div>
            </div>

            <div id="edu-screen" class="overlay hidden">
                <div class="overlay-content">
                    <h1 style="color: #ffcc00;">‚ö† –£–ì–†–û–ó–ê</h1>
                    <div class="info-card">
                        <div class="info-title" style="color:var(--neon-blue); margin-bottom:15px; font-weight:bold; font-size: 1.3rem;" id="edu-title">–¢–ò–ü</div>
                        <div id="edu-text">...</div>
                    </div>
                    <button class="btn" onclick="window.Game.closeEdu()">–ü–†–ò–ù–Ø–¢–û</button>
                </div>
            </div>

            <div id="choice-screen" class="overlay hidden">
                <div class="overlay-content">
                    <h1 id="choice-header">–î–ï–ô–°–¢–í–ò–ï</h1>
                    <p id="choice-desc" style="margin-bottom: 40px; font-size: 1.2rem; color: #ddd; max-width: 700px;">...</p>
                    <div id="choice-buttons" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;"></div>
                </div>
            </div>

            <div id="feedback-screen" class="overlay hidden">
                <div class="overlay-content">
                    <h1 id="fb-header">–ò–¢–û–ì</h1>
                    <p id="fb-desc" style="max-width: 650px; margin-bottom: 40px; font-size: 1.2rem; line-height: 1.5;">...</p>
                    <button class="btn" onclick="window.Game.resolveLevel()">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
                </div>
            </div>

            <div id="end-screen" class="overlay hidden">
                <div class="overlay-content">
                    <h1 id="end-title">–ö–û–ù–ï–¶</h1>
                    <h2 id="end-score" style="font-size: 5rem; color: white; margin: 30px 0; text-shadow: 0 0 30px var(--neon-blue);">0</h2>
                    <button class="btn" onclick="location.reload()">–ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        
        const firebaseConfig = { apiKey: "AIzaSyD6szist3gWxxnF3flxdJzFgjbPjmjq310", authDomain: "cybershield-b4422.firebaseapp.com", projectId: "cybershield-b4422", storageBucket: "cybershield-b4422.firebasestorage.app", messagingSenderId: "1048501198341", appId: "1:1048501198341:web:ad9d7f74c145a5a0a3466c", measurementId: "G-68L6Z80PX5" };
        let db = null; let isCloudActive = false;
        try { if (firebaseConfig.apiKey) { const app = initializeApp(firebaseConfig); db = getFirestore(app); isCloudActive = true; logToTerminal("CLOUD: –ü–æ–¥–∫–ª—é—á–µ–Ω–æ", "cloud"); } } catch (e) { console.error(e); }

        window.Stats = {
            async save(record) {
                const localData = JSON.parse(localStorage.getItem('CS_GM')) || [];
                localData.push(record);
                localStorage.setItem('CS_GM', JSON.stringify(localData));
                if (db && isCloudActive) {
                    try { 
                        const auth = getAuth();
                        if (!auth.currentUser) await signInAnonymously(auth);
                        await addDoc(collection(db, "mission_results"), { ...record, timestamp: Timestamp.now(), uid: auth.currentUser?.uid || 'anon' }); 
                        logToTerminal("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã", "success"); 
                    } catch (e) { logToTerminal("–°–±–æ–π —Å–µ—Ç–∏, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ", "warn"); }
                }
            },
            async show() {
                window.Sound.play('click');
                window.Game.hideAllOverlays();
                document.getElementById('stats-screen').classList.remove('hidden');
                const tbody = document.querySelector('#stats-table tbody');
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>';
                let data = [];
                if (db && isCloudActive) {
                    try { 
                        const auth = getAuth();
                        if (!auth.currentUser) await signInAnonymously(auth);
                        const q = query(collection(db, "mission_results"), orderBy("timestamp", "desc"), limit(12)); 
                        const snapshot = await getDocs(q); snapshot.forEach((doc) => data.push(doc.data())); 
                    } catch (e) {}
                }
                if (data.length === 0) { data = JSON.parse(localStorage.getItem('CS_GM')) || []; data.reverse(); }
                this.renderTable(data);
            },
            renderTable(data) {
                const tbody = document.querySelector('#stats-table tbody'); tbody.innerHTML = '';
                if(data.length === 0) tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#666;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
                data.forEach(rec => { 
                    const dateStr = rec.timestamp ? rec.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : rec.date;
                    const tr = document.createElement('tr'); 
                    tr.innerHTML = `<td>${dateStr}</td><td style="font-weight:bold; color:var(--neon-blue);">${rec.user}</td><td>${rec.score}</td><td>${rec.status}</td>`; 
                    tbody.appendChild(tr); 
                });
            },
            hide() { window.Sound.play('click'); document.getElementById('stats-screen').classList.add('hidden'); document.getElementById('start-screen').classList.remove('hidden'); },
            clearLocal() { window.Sound.play('click'); if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) { localStorage.removeItem('CS_GM'); this.show(); } }
        };

        function logToTerminal(msg, type) {
            const container = document.getElementById('side-menu');
            if(container) { const d = document.createElement('div'); d.className = `log-entry log-${type}`; d.innerText = `> ${msg}`; container.prepend(d); }
        }
    </script>

    <script>
        // --- AUDIO ENGINE ---
        window.Sound = {
            ctx: null,
            play(type) {
                if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                osc.connect(g); g.connect(this.ctx.destination);
                
                if(type === 'success') {
                    osc.frequency.setValueAtTime(523, now);
                    osc.frequency.exponentialRampToValueAtTime(880, now + 0.3);
                    g.gain.setValueAtTime(0.1, now);
                } else if(type === 'error') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(110, now);
                    g.gain.setValueAtTime(0.1, now);
                } else {
                    osc.frequency.setValueAtTime(800, now);
                    g.gain.setValueAtTime(0.05, now);
                }
                osc.start(); osc.stop(now + 0.4);
            }
        };

        window.UI = {
            showToast(text) {
                const t = document.getElementById('toast');
                t.innerText = text;
                t.style.opacity = '1';
                setTimeout(() => t.style.opacity = '0', 3000);
            },
            toggleTerminal() {
                window.Sound.play('click');
                const term = document.getElementById('side-menu');
                const btn = document.getElementById('btn-logs');
                const trap = document.getElementById('click-trap');
                term.classList.toggle('collapsed');
                if (!term.classList.contains('collapsed')) { btn.innerHTML = "&#10005;"; trap.classList.add('active'); } 
                else { btn.innerHTML = "&#9776;"; trap.classList.remove('active'); }
            },
            toggleFullscreen() {
                window.Sound.play('click');
                const elem = document.documentElement;
                
                if (!document.fullscreenElement) {
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen().then(() => {
                            if (screen.orientation && screen.orientation.lock) {
                                screen.orientation.lock('landscape').catch((e) => {});
                            }
                        }).catch(err => {});
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            },
            syncIcon() {
                const btn = document.getElementById('btn-fullscreen');
                const isFs = document.fullscreenElement || document.webkitFullscreenElement;
                if(btn) btn.innerHTML = isFs ? "&#10005;" : "üì∫";
            }
        };

        document.addEventListener('fullscreenchange', window.UI.syncIcon);
        document.addEventListener('webkitfullscreenchange', window.UI.syncIcon);

        // --- SCENARIOS ---
        const SCENARIOS = [
            { id: "intro", type: "video", src: "intro.mp4", simText: "–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø...", log: "–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∑–∞—â–∏—Ç—ã..." },
            { id: "ai_scan", type: "video", src: "ai_scan.mp4", simText: "–°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï...", log: "–ê–Ω–∞–ª–∏–∑ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π..." },
            { id: "l1_theory", type: "education", title: "–§–ò–®–ò–ù–ì", text: "–ú–µ—Ç–æ–¥ –æ–±–º–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∫—Ä–∞–∂–∏ –¥–∞–Ω–Ω—ã—Ö. –ß–∞—Å—Ç–æ –º–∞—Å–∫–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.", log: "–û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫." },
            { id: "l1_act", type: "video", src: "phishing.mp4", simText: "–í–•–û–î–Ø–©–ï–ï...", log: "–ü–æ–ª—É—á–µ–Ω–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ." },
            { id: "l1_choice", type: "choice", header: "–ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–ê–Ø –°–°–´–õ–ö–ê", desc: "–ü–∏—Å—å–º–æ: '–°—Ä–æ—á–Ω–æ —Å–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∏–∂–µ'. –ß—Ç–æ —Å–¥–µ–ª–∞–µ—Ç–µ?", options: [
                { text: "üõ°Ô∏è –£–î–ê–õ–ò–¢–¨", correct: true, feedback: "–í–µ—Ä–Ω–æ. –≠—Ç–æ —Ç–∏–ø–∏—á–Ω—ã–π —Ñ–∏—à–∏–Ω–≥.", score: 500 },
                { text: "‚ò£ –ü–ï–†–ï–ô–¢–ò", correct: false, feedback: "–û—à–∏–±–∫–∞! –í–∞—à–∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω—ã.", score: 0, damage: 35 }
            ]},
            { id: "l3_edu", type: "education", title: "–°–™–ï–ú–ù–´–ï –ù–û–°–ò–¢–ï–õ–ò", text: "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–π—Ç–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–ª–µ—à–∫–∏. –û–Ω–∏ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω–æ–µ –ü–û.", log: "–ê–Ω–∞–ª–∏–∑: –í–Ω–µ—à–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ." },
            { id: "l3_act", type: "video", src: "usb.mp4", simText: "–°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï USB...", log: "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ." },
            { id: "l3_choice", type: "choice", header: "–ù–ê–ô–î–ï–ù–ê –§–õ–ï–®–ö–ê", desc: "–í—ã –Ω–∞—à–ª–∏ —Ñ–ª–µ—à–∫—É —Å –Ω–∞–¥–ø–∏—Å—å—é '–°–ï–ö–†–ï–¢–ù–û' –≤ –∫–æ—Ä–∏–¥–æ—Ä–µ. –í–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è?", options: [
                { text: "üîí –û–¢–î–ê–¢–¨ –û–•–†–ê–ù–ï", correct: true, feedback: "–ü—Ä–∞–≤–∏–ª—å–Ω–æ. –≠—Ç–æ –º–æ–≥ –±—ã—Ç—å –≤–∏—Ä—É—Å.", score: 1000 },
                { text: "üîå –í–°–¢–ê–í–ò–¢–¨ –í –ü–ö", correct: false, feedback: "–û—à–∏–±–∫–∞! –í–∏—Ä—É—Å –ø—Ä–æ–Ω–∏–∫ –≤ —Å–µ—Ç—å.", score: 0, damage: 40 }
            ]},
            { id: "l4_edu", type: "education", title: "–ü–ê–†–û–õ–ò", text: "–°–ª–∞–±—ã–µ –ø–∞—Ä–æ–ª–∏ (123456) –≤–∑–ª–∞–º—ã–≤–∞—é—Ç—Å—è –∑–∞ —Å–µ–∫—É–Ω–¥—ã.", log: "–ê–Ω–∞–ª–∏–∑: Brute-Force –∞—Ç–∞–∫–∞." },
            { id: "l4_act", type: "video", src: "hack.mp4", simText: "–ü–û–ü–´–¢–ö–ê –í–•–û–î–ê...", log: "–û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–µ—Ä–µ–±–æ—Ä –ø–∞—Ä–æ–ª–µ–π." },
            { id: "l4_choice", type: "choice", header: "–í–ó–õ–û–ú –ê–ö–ö–ê–£–ù–¢–ê", desc: "–°–∏—Å—Ç–µ–º–∞ —Å–æ–æ–±—â–∞–µ—Ç –æ –ø–æ–ø—ã—Ç–∫–µ –≤—Ö–æ–¥–∞ —Å –Ω–µ–∑–Ω–∞–∫–æ–º–æ–≥–æ IP. –í–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è?", options: [
                { text: "üîê –°–ú–ï–ù–ò–¢–¨ –ü–ê–†–û–õ–¨", correct: true, feedback: "–û—Ç–ª–∏—á–Ω–æ. –í—ã –æ—Ç—Å–µ–∫–ª–∏ —Ö–∞–∫–µ—Ä–∞.", score: 1000 },
                { text: "ü§∑ –ò–ì–ù–û–†–ò–†–û–í–ê–¢–¨", correct: false, feedback: "–û—à–∏–±–∫–∞. –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –≤–∑–ª–æ–º–∞–Ω.", score: 0, damage: 50 }
            ]},
            { id: "l2_alert", type: "video", src: "virus_map.mp4", simText: "–¢–†–ï–í–û–ì–ê...", log: "–í–ù–ò–ú–ê–ù–ò–ï: –í–∏—Ä—É—Å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å." },
            { id: "l2_boss", type: "video", src: "glitch.mp4", simText: "–í–ó–õ–û–ú...", log: "–•–∞–∫–µ—Ä –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ." },
            { id: "l2_choice", type: "choice", header: "–®–ò–§–†–û–í–ê–õ–¨–©–ò–ö", desc: "–≠–∫—Ä–∞–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ —Ç—Ä–µ–±—É–µ—Ç –≤—ã–∫—É–ø. –ß—Ç–æ –±—É–¥–µ—Ç–µ –¥–µ–ª–∞—Ç—å?", options: [
                { text: "üí∏ –ó–ê–ü–õ–ê–¢–ò–¢–¨", correct: false, feedback: "–û—à–∏–±–∫–∞. –î–µ–Ω—å–≥–∏ –ø–æ—Ç–µ—Ä—è–Ω—ã.", score: 0, damage: 50 },
                { text: "üîß –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨", correct: true, feedback: "–£—Å–ø–µ—Ö! –°–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.", score: 1000 }
            ]}
        ];

        // --- SMART LAZY PRELOADER (SOLUTION 2) ---
        window.Preloader = {
            loadedCount: 0,
            cache: {},
            
            // 1. –ì—Ä—É–∑–∏–º —Ç–æ–ª—å–∫–æ –í–ê–ñ–ù–´–ï –≤–∏–¥–µ–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ (–ò–Ω—Ç—Ä–æ)
            async init() {
                const priority = ["intro.mp4", "ai_scan.mp4"]; // –¢–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ
                const toast = document.getElementById('toast');
                if(toast) { toast.style.opacity = '1'; toast.innerText = "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã..."; }

                await this.loadList(priority);
                
                if(toast) { 
                    toast.innerText = "–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞"; 
                    setTimeout(() => toast.style.opacity = '0', 2000);
                }

                // 2. –û—Å—Ç–∞–ª—å–Ω–æ–µ –¥–æ–∫–∞—á–∏–≤–∞–µ–º —Ç–∏—Ö–æ –≤ —Ñ–æ–Ω–µ
                const others = SCENARIOS.filter(s => s.type === 'video' && !priority.includes(s.src)).map(s => s.src);
                this.loadList(others, true); // true = —Ñ–æ–Ω–æ–≤—ã–π —Ä–µ–∂–∏–º (–±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
            },

            async loadList(files, isBackground = false) {
                const promises = files.map(src => {
                    if (this.cache[src]) return Promise.resolve(); // –£–∂–µ –µ—Å—Ç—å
                    return fetch(src)
                        .then(r => r.blob())
                        .then(blob => {
                            const url = URL.createObjectURL(blob);
                            this.cache[src] = url;
                            // –ü–æ–¥–º–µ–Ω—è–µ–º —Å—Å—ã–ª–∫—É –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏
                            SCENARIOS.forEach(s => { if(s.src === src) s.src = url; });
                            if(!isBackground) console.log(`Loaded: ${src}`);
                        })
                        .catch(e => console.warn(`Failed ${src}`, e));
                });
                if (!isBackground) await Promise.allSettled(promises); // –ñ–¥–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ
            }
        };
        
        // –ó–∞–ø—É—Å–∫
        window.Preloader.init();

        window.Game = {
            state: { stepIndex: 0, score: 0, health: 100, user: "GUEST" },
            isBusy: false,

            init() {
                if(this.isBusy) return;
                this.isBusy = true;
                window.Sound.play('click');
                const name = document.getElementById('username-input').value.trim();
                if(name) this.state.user = name;
                document.getElementById('user-name-display').innerText = this.state.user;
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('hud').classList.remove('hidden');
                
                const v = document.getElementById('video-layer');
                v.muted = false; v.volume = 1.0;
                v.play().then(() => v.pause()).catch(() => {});
                
                window.UI.syncIcon();
                this.isBusy = false;
                this.runStep();
            },
            runStep() {
                if (this.state.stepIndex >= SCENARIOS.length) { this.finish(true); return; }
                const s = SCENARIOS[this.state.stepIndex];
                if(s.log) this.log(s.log);
                if(s.type === 'video') this.playVideo(s);
                else if(s.type === 'education') this.showEdu(s);
                else if(s.type === 'choice') this.showChoice(s);
            },
            playVideo(s) {
                this.hideAllOverlays();
                const v = document.getElementById('video-layer');
                const sim = document.getElementById('sim-layer');
                v.classList.remove('playing');
                sim.classList.remove('fade-out');
                
                document.getElementById('game-viewport').classList.add('video-mode');
                document.getElementById('sim-text').innerText = s.simText;

                v.src = s.src; v.load();
                
                setTimeout(() => {
                    const promise = v.play();
                    if (promise !== undefined) {
                        promise.then(() => {
                            v.classList.add('playing'); 
                            sim.classList.add('fade-out'); 
                        }).catch(() => {
                            setTimeout(() => this.nextStep(), 3500); 
                        });
                    }
                }, 50);

                v.onended = () => {
                    document.getElementById('game-viewport').classList.remove('video-mode');
                    this.nextStep();
                };
                v.onerror = () => this.nextStep();
            },
            showEdu(s) {
                this.hideAllOverlays();
                document.getElementById('edu-title').innerText = s.title;
                document.getElementById('edu-text').innerText = s.text;
                document.getElementById('edu-screen').classList.remove('hidden');
            },
            closeEdu() {
                if(this.isBusy) return;
                this.isBusy = true;
                window.Sound.play('click');
                document.getElementById('edu-screen').classList.add('hidden');
                setTimeout(() => { this.isBusy = false; this.nextStep(); }, 100);
            },
            showChoice(s) {
                this.hideAllOverlays();
                document.getElementById('choice-header').innerText = s.header;
                document.getElementById('choice-desc').innerText = s.desc;
                const c = document.getElementById('choice-buttons');
                c.innerHTML = '';
                s.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    btn.innerText = opt.text;
                    btn.onclick = () => this.handleChoice(opt);
                    c.appendChild(btn);
                });
                document.getElementById('choice-screen').classList.remove('hidden');
            },
            handleChoice(opt) {
                if(this.isBusy) return;
                this.isBusy = true;
                window.Sound.play(opt.correct ? 'success' : 'error');
                document.getElementById('choice-screen').classList.add('hidden');
                
                this.log(`–†–µ—à–µ–Ω–∏–µ: ${opt.text}`, opt.correct ? 'success' : 'warn');
                if(opt.score) this.state.score += opt.score;
                if(opt.damage) this.updateHealth(-opt.damage);
                document.getElementById('score-val').innerText = this.state.score;
                document.getElementById('fb-header').innerText = opt.correct ? "–£–°–ü–ï–•" : "–ü–†–û–í–ê–õ";
                document.getElementById('fb-header').style.color = opt.correct ? "var(--neon-green)" : "var(--neon-red)";
                document.getElementById('fb-desc').innerText = opt.feedback;
                
                document.getElementById('feedback-screen').classList.remove('hidden');
                setTimeout(() => { this.isBusy = false; }, 500);
            },
            resolveLevel() { 
                if(this.isBusy) return;
                this.isBusy = true;
                window.Sound.play('click');
                document.getElementById('feedback-screen').classList.add('hidden');
                
                setTimeout(() => { 
                    this.isBusy = false; 
                    if (this.state.health <= 0) {
                        this.finish(false); 
                    } else {
                        this.nextStep(); 
                    }
                }, 100);
            },
            nextStep() { this.state.stepIndex++; this.runStep(); },
            updateHealth(v) {
                this.state.health = Math.max(0, this.state.health + v);
                const fill = document.getElementById('health-bar-fill');
                fill.style.width = this.state.health + "%";
                if(this.state.health < 30) fill.style.background = 'var(--neon-red)';
                else fill.style.background = 'var(--neon-green)';
            },
            log(msg, type='info') {
                const logs = document.getElementById('side-menu');
                if(logs) {
                    const d = document.createElement('div');
                    d.className = `log-entry log-${type}`;
                    d.innerText = `> ${msg}`;
                    logs.prepend(d);
                }
            },
            finish(isWin) {
                this.hideAllOverlays();
                const v = document.getElementById('video-layer');
                const sim = document.getElementById('sim-layer');
                
                document.getElementById('game-viewport').classList.add('video-mode');
                v.src = isWin ? "win.mp4" : "lose.mp4"; v.load();
                
                const onEnd = () => {
                    document.getElementById('game-viewport').classList.remove('video-mode');
                    window.Sound.play(isWin ? 'success' : 'error');
                    const scr = document.getElementById('end-screen');
                    scr.classList.remove('hidden');
                    document.getElementById('end-title').innerText = isWin ? "–ú–ò–°–°–ò–Ø –í–´–ü–û–õ–ù–ï–ù–ê" : "–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –°–ë–û–ô";
                    document.getElementById('end-title').style.color = isWin ? "var(--neon-green)" : "var(--neon-red)";
                    document.getElementById('end-score').innerText = `${this.state.score}`;
                    if(window.Stats) window.Stats.save({
                        date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        user: this.state.user,
                        score: this.state.score,
                        status: isWin ? 'WIN' : 'FAIL'
                    });
                };

                setTimeout(() => {
                    v.play().then(() => { 
                        v.classList.add('playing'); 
                        sim.classList.add('fade-out'); 
                    }).catch(() => { 
                        v.onended();
                    });
                }, 100);
                
                v.onended = onEnd;
                v.onerror = onEnd;
            },
            hideAllOverlays() { document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden')); },
            toggleScreen(id, show) { const el = document.getElementById(id); show ? el.classList.remove('hidden') : el.classList.add('hidden'); }
        };
    </script>
</body>
</html>
