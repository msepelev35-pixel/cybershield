<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∏—Å—Å–∏—è: –ö–∏–±–µ—Ä—â–∏—Ç | Cloud System</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* --- CSS STYLES --- */
        :root {
            --neon-blue: #00f3ff;
            --neon-green: #0aff0a;
            --neon-red: #ff003c;
            --bg-color: #050505;
            --glass: rgba(10, 20, 30, 0.90);
        }
        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 50%, #1a2a3a 0%, #000 100%);
            color: white;
            font-family: 'Orbitron', sans-serif;
            overflow: hidden;
            height: 100dvh; /* Dynamic viewport height for mobile */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        #main-wrapper {
            display: flex;
            width: 95vw;
            height: 90vh;
            max-width: 1400px;
            gap: 20px;
            transition: all 0.3s;
        }

        /* --- –õ–û–ì–ò (–¢–ï–†–ú–ò–ù–ê–õ) --- */
        #system-logs {
            flex: 1; 
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333; 
            border-left: 4px solid var(--neon-blue);
            padding: 15px; 
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.85rem; 
            color: var(--neon-blue);
            overflow-y: auto; 
            display: flex; 
            flex-direction: column-reverse;
            text-shadow: 0 0 5px var(--neon-blue); 
            border-radius: 10px;
            min-width: 250px;
        }
        .log-entry { margin-bottom: 5px; opacity: 0.9; border-bottom: 1px solid #111; padding-bottom: 2px; }
        .log-warn { color: var(--neon-red); }
        .log-success { color: var(--neon-green); }
        .log-cloud { color: #ffcc00; }

        /* --- –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù --- */
        #game-viewport {
            flex: 3; 
            position: relative; 
            background: #000;
            border: 2px solid var(--neon-blue); 
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(0, 243, 255, 0.15);
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
        }
        /* Scanlines —ç—Ñ—Ñ–µ–∫—Ç */
        #game-viewport::after {
            content: " "; position: absolute; inset: 0;
            background: repeating-linear-gradient(transparent, transparent 2px, rgba(0, 255, 255, 0.03) 3px);
            pointer-events: none; z-index: 10;
        }

        video { width: 100%; height: 100%; object-fit: cover; display: none; }

        #sim-layer {
            position: absolute; inset: 0; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            background: radial-gradient(circle, #001a33 0%, #000 100%);
        }
        .loader-ring {
            width: 60px; height: 60px;
            border: 4px solid transparent; border-top-color: var(--neon-blue);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- HUD (–í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨) --- */
        #hud {
            position: absolute; top: 0; left: 0; right: 0;
            padding: 15px; display: flex; justify-content: space-between;
            z-index: 20; text-transform: uppercase; font-size: 0.9rem; pointer-events: none;
        }
        .hud-item {
            background: rgba(0,0,0,0.8); border: 1px solid var(--neon-blue);
            padding: 5px 12px; border-radius: 6px;
            display: flex; align-items: center; gap: 8px; backdrop-filter: blur(4px);
        }
        #health-bar-container { width: 80px; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        #health-bar-fill { width: 100%; height: 100%; background: var(--neon-green); transition: 0.5s; }

        /* --- UI OVERLAYS (–≠–ö–†–ê–ù–´) --- */
        .overlay {
            position: absolute; inset: 0; background: var(--glass);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 30;
            text-align: center; padding: 20px; transition: opacity 0.3s;
        }
        .hidden { opacity: 0; pointer-events: none; display: none !important; }

        h1 { color: var(--neon-blue); text-shadow: 0 0 15px var(--neon-blue); margin: 0 0 10px 0; font-size: 2rem; line-height: 1.1; }
        h2 { color: #ccc; font-size: 1rem; max-width: 600px; margin-bottom: 25px; }
        
        /* –ö–ù–û–ü–ö–ò */
        .btn {
            background: rgba(0, 243, 255, 0.1); color: var(--neon-blue);
            border: 1px solid var(--neon-blue); padding: 12px 30px;
            font-family: 'Orbitron', sans-serif; font-size: 1rem;
            cursor: pointer; transition: 0.2s; text-transform: uppercase;
            margin: 8px; position: relative; overflow: hidden;
            border-radius: 4px; user-select: none;
            touch-action: manipulation; /* –£–ª—É—á—à–∞–µ—Ç —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ —Ç–∞—á */
        }
        .btn:active { transform: scale(0.96); background: var(--neon-blue); color: #000; }
        .btn-danger { border-color: var(--neon-red); color: var(--neon-red); background: rgba(255, 0, 60, 0.1); }
        .btn-danger:active { background: var(--neon-red); color: white; }

        .info-card {
            background: rgba(0,0,0,0.6); border-left: 4px solid var(--neon-blue);
            padding: 15px; text-align: left; max-width: 600px; margin-bottom: 20px;
            font-size: 0.95rem; line-height: 1.4;
        }

        /* --- ADMIN PANEL --- */
        #admin-panel {
            width: 90%; max-width: 800px; max-height: 70%;
            background: rgba(0,0,0,0.95); border: 1px solid #444;
            overflow-y: auto; text-align: left; padding: 15px;
            font-family: 'Share Tech Mono', monospace; font-size: 0.8rem;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #333; padding: 8px; text-align: left; }
        th { color: var(--neon-blue); position: sticky; top: 0; background: #000; }
        .status-win { color: var(--neon-green); }
        .status-fail { color: var(--neon-red); }

        /* =========================================
           MOBILE ADAPTATION (VERTICAL MODE)
           ========================================= */
        @media (max-width: 900px) {
            body { height: 100dvh; background: #000; } /* –£–±–∏—Ä–∞–µ–º —Å–ª–æ–∂–Ω—ã–π —Ñ–æ–Ω –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ */
            
            #main-wrapper {
                flex-direction: column; /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ */
                width: 100%;
                height: 100%;
                gap: 0;
            }

            /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ –∑–∞–Ω–∏–º–∞–µ—Ç –≤–µ—Ä—Ö–Ω–∏–µ 65% */
            #game-viewport {
                flex: 65;
                width: 100%;
                border-radius: 0;
                border: none;
                border-bottom: 2px solid var(--neon-blue);
            }

            /* –¢–µ—Ä–º–∏–Ω–∞–ª –∑–∞–Ω–∏–º–∞–µ—Ç –Ω–∏–∂–Ω–∏–µ 35% */
            #system-logs {
                display: flex; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª! */
                flex: 35;
                width: 100%;
                border-radius: 0;
                border: none;
                background: #050505;
                padding: 10px;
                font-size: 0.75rem;
            }

            /* –ö–Ω–æ–ø–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º - –≤–æ –≤—Å—é —à–∏—Ä–∏–Ω—É */
            #choice-buttons {
                display: flex;
                flex-direction: column;
                width: 100%;
                padding: 0 20px;
            }
            .btn {
                width: 100%;
                margin: 5px 0;
                padding: 15px;
                font-size: 1.1rem; /* –ö—Ä—É–ø–Ω–µ–µ —à—Ä–∏—Ñ—Ç */
            }

            /* –®—Ä–∏—Ñ—Ç—ã –∏ –æ—Ç—Å—Ç—É–ø—ã */
            h1 { font-size: 1.5rem; }
            h2 { font-size: 0.9rem; }
            .info-card { font-size: 0.85rem; padding: 10px; }
            
            /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã HUD, –µ—Å–ª–∏ —Ç–µ—Å–Ω–æ */
            #hud { padding: 10px; }
            .hud-item { padding: 4px 8px; font-size: 0.8rem; }
            
            /* –£–±–∏—Ä–∞–µ–º "–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ" - –æ–Ω–æ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ */
            #rotate-device { display: none !important; }
        }
    </style>
</head>
<body>

    <audio id="sfx-hover" src="click.mp3"></audio>

    <div id="main-wrapper">
        <!-- 1. –ò–ì–†–û–í–û–ï –û–ö–ù–û (–¢–µ–ø–µ—Ä—å —Å–≤–µ—Ä—Ö—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö) -->
        <div id="game-viewport">
            <video id="video-layer" playsinline></video>
            <div id="sim-layer"><div class="loader-ring"></div><h2 style="margin-top:20px" id="sim-text">–ó–ê–ì–†–£–ó–ö–ê...</h2></div>

            <!-- HUD -->
            <div id="hud" class="hidden">
                <div class="hud-item">üõ°Ô∏è <div id="health-bar-container"><div id="health-bar-fill"></div></div> <span id="health-val">100%</span></div>
                <div class="hud-item">üë§ <span id="user-name-display">GUEST</span></div>
                <div class="hud-item">üí† <span id="score-val">0</span></div>
            </div>

            <!-- START SCREEN -->
            <div id="start-screen" class="overlay">
                <h1 style="margin-bottom: 5px;">CYBERSHIELD 3.0</h1>
                <h2 style="color: var(--neon-green); margin-bottom: 20px;">MOBILE READY SYSTEM</h2>
                
                <input type="text" id="username-input" placeholder="–ò–ú–Ø –ü–ò–õ–û–¢–ê" maxlength="12"
                       style="background: rgba(255,255,255,0.1); border: 1px solid #555; padding: 12px; color: white; font-family: inherit; margin-bottom: 15px; text-align: center; width: 80%; font-size: 1.2rem; border-radius: 5px; outline: none;">
                
                <div style="display: flex; flex-direction: column; width: 80%;">
                    <button class="btn" onclick="window.Game.init()">üöÄ –ó–ê–ü–£–°–ö</button>
                    <button class="btn" style="border-color: #444; color: #aaa; font-size: 0.9rem;" onclick="window.Stats.show()">üìä –ë–ê–ó–ê –î–ê–ù–ù–´–•</button>
                </div>
            </div>

            <!-- STATS SCREEN -->
            <div id="stats-screen" class="overlay hidden">
                <h1 style="font-size: 1.5rem;">–ê–†–•–ò–í –î–ê–ù–ù–´–•</h1>
                <div id="admin-panel">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.8rem;">
                        <span id="connection-status" style="color:#666">‚ö´ OFFLINE</span>
                        <span>–ó–ê–ü–ò–°–ï–ô: <b id="stat-total">0</b></span>
                    </div>
                    <table id="stats-table">
                        <thead><tr><th>TIME</th><th>USER</th><th>SCR</th><th>STS</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn" onclick="window.Stats.hide()">–ù–ê–ó–ê–î</button>
                    <button class="btn btn-danger" onclick="window.Stats.clearLocal()">CLEAR</button>
                </div>
            </div>

            <!-- GAME SCREENS -->
            <div id="edu-screen" class="overlay hidden">
                <h1 style="font-size: 1.5rem; color: #ffcc00">‚ö† –£–ì–†–û–ó–ê</h1>
                <div class="info-card">
                    <div class="info-title" id="edu-title">–¢–ò–ü</div>
                    <div id="edu-text">...</div>
                </div>
                <button class="btn" onclick="window.Game.nextStep()">–ü–û–ù–Ø–õ</button>
            </div>

            <div id="choice-screen" class="overlay hidden">
                <h1 id="choice-header">–í–•–û–î–Ø–©–ò–ô –ó–ê–ü–†–û–°</h1>
                <p id="choice-desc" style="margin-bottom: 20px;">...</p>
                <div id="choice-buttons"></div>
            </div>

            <div id="feedback-screen" class="overlay hidden">
                <h1 id="fb-header">–ò–¢–û–ì</h1>
                <p id="fb-desc" style="max-width: 500px; margin-bottom: 20px;">...</p>
                <button class="btn" onclick="window.Game.resolveLevel()">–î–ê–õ–ï–ï</button>
            </div>

            <div id="end-screen" class="overlay hidden">
                <h1 id="end-title">–ö–û–ù–ï–¶</h1>
                <h2 id="end-score" style="font-size: 2rem; color: white;">0</h2>
                <button class="btn" onclick="location.reload()">–ú–ï–ù–Æ</button>
            </div>
        </div>

        <!-- 2. –õ–û–ì–ò (–¢–µ–ø–µ—Ä—å —Å–Ω–∏–∑—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö) -->
        <div id="system-logs">
            <div class="log-entry log-info">> –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞... OK</div>
            <div class="log-entry log-info">> –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω... OK</div>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBAKN2b8ZsWpbnTPdgOKIoG_moCAZdR6mc",
            authDomain: "cybershield-b4422.firebaseapp.com",
            projectId: "cybershield-b4422",
            storageBucket: "cybershield-b4422.firebasestorage.app",
            messagingSenderId: "1048501198341",
            appId: "1:1048501198341:web:ad9d7f74c145a5a0a3466c",
            measurementId: "G-68L6Z80PX5"
        };

        let db = null;
        let isCloudActive = false;

        try {
            if (firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                isCloudActive = true;
                logToTerminal("Google Cloud –ø–æ–¥–∫–ª—é—á–µ–Ω", "cloud");
            }
        } catch (e) { console.error(e); }

        window.Stats = {
            localKey: 'CYBERSHIELD_LOCAL_V3',
            async save(record) {
                const localData = JSON.parse(localStorage.getItem(this.localKey)) || [];
                localData.push(record);
                localStorage.setItem(this.localKey, JSON.stringify(localData));
                if (isCloudActive && db) {
                    try {
                        logToTerminal("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±–ª–∞–∫–æ–º...", "cloud");
                        await addDoc(collection(db, "mission_results"), { ...record, timestamp: Timestamp.now() });
                        logToTerminal("–£—Å–ø–µ—à–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ –ë–î", "success");
                    } catch (e) { logToTerminal("–û—à–∏–±–∫–∞ –æ–±–ª–∞–∫–∞", "warn"); }
                }
            },
            async show() {
                window.Game.hideAllOverlays();
                document.getElementById('stats-screen').classList.remove('hidden');
                const statusEl = document.getElementById('connection-status');
                const tbody = document.querySelector('#stats-table tbody');
                tbody.innerHTML = '<tr><td colspan="4">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
                let data = [];

                if (isCloudActive && db) {
                    try {
                        statusEl.innerHTML = 'üü¢ ONLINE'; statusEl.style.color = 'var(--neon-green)';
                        const q = query(collection(db, "mission_results"), orderBy("timestamp", "desc"), limit(30));
                        const snapshot = await getDocs(q);
                        snapshot.forEach((doc) => data.push(doc.data()));
                    } catch (e) { statusEl.innerText = 'üî¥ ERROR'; }
                } else { statusEl.innerText = 'üü° LOCAL'; }

                if (data.length === 0) {
                    data = JSON.parse(localStorage.getItem(this.localKey)) || [];
                    data.reverse();
                }
                this.renderTable(data);
            },
            renderTable(data) {
                const tbody = document.querySelector('#stats-table tbody');
                tbody.innerHTML = '';
                document.getElementById('stat-total').innerText = data.length;
                data.forEach(rec => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${rec.date.split(' ')[0]}</td><td style="font-weight:bold; max-width: 80px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${rec.user}</td><td>${rec.score}</td><td class="${rec.status === 'WIN' ? 'status-win' : 'status-fail'}">${rec.status === 'WIN' ? 'OK' : 'FAIL'}</td>`;
                    tbody.appendChild(tr);
                });
            },
            hide() { document.getElementById('stats-screen').classList.add('hidden'); document.getElementById('start-screen').classList.remove('hidden'); },
            clearLocal() { if(confirm('–£–¥–∞–ª–∏—Ç—å –∫—ç—à?')) { localStorage.removeItem(this.localKey); this.show(); } }
        };

        function logToTerminal(msg, type) {
            const container = document.getElementById('system-logs');
            if(container) {
                const d = document.createElement('div');
                d.className = `log-entry log-${type}`;
                d.innerText = `> ${msg}`;
                container.prepend(d);
            }
        }
    </script>

    <script>
        // –°–¶–ï–ù–ê–†–ò–ò
        const SCENARIOS = [
            { id: "intro", type: "video", src: "intro.mp4", simText: "–ó–ê–ì–†–£–ó–ö–ê...", log: "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã..." },
            { id: "l1_theory", type: "education", title: "–§–ò–®–ò–ù–ì", text: "–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ —Å —Ü–µ–ª—å—é –∫—Ä–∞–∂–∏ –ø–∞—Ä–æ–ª–µ–π. –ü—Ä–∏–∑–Ω–∞–∫–∏: —Å—Ä–æ—á–Ω–æ—Å—Ç—å, –æ–±–µ—â–∞–Ω–∏–µ –≤—ã–≥–æ–¥—ã.", log: "–ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞—Ñ–∏–∫–∞: –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π Email." },
            { id: "l1_act", type: "video", src: "phishing.mp4", simText: "–í–•–û–î–Ø–©–ï–ï –°–û–û–ë–©–ï–ù–ò–ï...", log: "–°–æ–±—ã—Ç–∏–µ: –ü–∏—Å—å–º–æ —Å –≤–ª–æ–∂–µ–Ω–∏–µ–º." },
            { id: "l1_choice", type: "choice", header: "–°–°–´–õ–ö–ê", desc: "–í–∞–º –ø—Ä–∏—à–ª–æ –ø–∏—Å—å–º–æ: '–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –ø–ª–∞–Ω—à–µ—Ç! –ñ–º–∏ —Å—é–¥–∞!'", options: [
                { text: "üõ°Ô∏è –£–î–ê–õ–ò–¢–¨ –ü–ò–°–¨–ú–û", correct: true, feedback: "–í–µ—Ä–Ω–æ! –°—Å—ã–ª–∫–∞ –≤–µ–ª–∞ –Ω–∞ —Ñ–∏—à–∏–Ω–≥–æ–≤—ã–π —Å–∞–π—Ç.", score: 500 },
                { text: "üéÅ –û–¢–ö–†–´–¢–¨ –°–°–´–õ–ö–£", correct: false, feedback: "–û—à–∏–±–∫–∞! –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω, —Å–∏—Å—Ç–µ–º–∞ –∑–∞—Ä–∞–∂–µ–Ω–∞.", score: 0, damage: 30 }
            ]},
            { id: "l2_virus", type: "video", src: "virus_map.mp4", simText: "–í–ò–†–£–°...", log: "–í–ù–ò–ú–ê–ù–ò–ï: –°–µ—Ç–µ–≤–∞—è –∞—Ç–∞–∫–∞." },
            { id: "l2_choice", type: "choice", header: "–í–´–ú–û–ì–ê–¢–ï–õ–¨", desc: "–≠–∫—Ä–∞–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –¢—Ä–µ–±—É—é—Ç –≤—ã–∫—É–ø.", options: [
                { text: "üí∏ –ó–ê–ü–õ–ê–¢–ò–¢–¨", correct: false, feedback: "–ü—Ä–æ–≤–∞–ª. –î–æ—Å—Ç—É–ø –Ω–µ –≤–µ—Ä–Ω—É–ª–∏.", score: 0, damage: 100 },
                { text: "üîß –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨", correct: true, feedback: "–£—Å–ø–µ—Ö! –°–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ –±—ç–∫–∞–ø–∞.", score: 1000 }
            ]},
             { id: "win", type: "video", src: "win.mp4", simText: "–ü–û–ë–ï–î–ê", log: "–°–∏—Å—Ç–µ–º–∞ —á–∏—Å—Ç–∞." }
        ];

        window.Game = {
            state: { stepIndex: 0, score: 0, health: 100, user: "GUEST" },
            init() {
                const name = document.getElementById('username-input').value.trim();
                if(name) this.state.user = name;
                document.getElementById('user-name-display').innerText = this.state.user;
                this.toggleScreen('start-screen', false);
                document.getElementById('hud').classList.remove('hidden');
                this.runStep();
            },
            runStep() {
                if (this.state.stepIndex >= SCENARIOS.length) { this.finish(true); return; }
                const s = SCENARIOS[this.state.stepIndex];
                if(s.log) this.log(s.log);
                if(s.type === 'video') this.playVideo(s);
                else if(s.type === 'education') this.showEdu(s);
                else if(s.type === 'choice') this.showChoice(s);
            },
            playVideo(s) {
                this.hideAllOverlays();
                const v = document.getElementById('video-layer');
                const sim = document.getElementById('sim-layer');
                v.style.display = 'block'; sim.style.display = 'none';
                v.src = s.src;
                v.play().catch(() => { v.style.display='none'; sim.style.display='flex'; document.getElementById('sim-text').innerText=s.simText; setTimeout(()=>this.nextStep(),2500); });
                v.onended = () => this.nextStep();
                v.onerror = () => v.onended();
            },
            showEdu(s) {
                this.hideAllOverlays();
                document.getElementById('edu-title').innerText = s.title;
                document.getElementById('edu-text').innerText = s.text;
                document.getElementById('edu-screen').classList.remove('hidden');
            },
            showChoice(s) {
                this.hideAllOverlays();
                document.getElementById('choice-header').innerText = s.header;
                document.getElementById('choice-desc').innerText = s.desc;
                const c = document.getElementById('choice-buttons');
                c.innerHTML = '';
                s.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = opt.correct ? 'btn' : 'btn btn-danger';
                    btn.innerText = opt.text;
                    btn.onclick = () => this.handleChoice(opt);
                    c.appendChild(btn);
                });
                document.getElementById('choice-screen').classList.remove('hidden');
            },
            handleChoice(opt) {
                this.log(`–†–µ—à–µ–Ω–∏–µ: ${opt.text}`, opt.correct ? 'success' : 'warn');
                if(opt.score) this.state.score += opt.score;
                if(opt.damage) this.updateHealth(-opt.damage);
                document.getElementById('score-val').innerText = this.state.score;
                document.getElementById('fb-header').innerText = opt.correct ? "–£–°–ü–ï–•" : "–û–®–ò–ë–ö–ê";
                document.getElementById('fb-header').style.color = opt.correct ? "var(--neon-green)" : "var(--neon-red)";
                document.getElementById('fb-desc').innerText = opt.feedback;
                this.toggleScreen('choice-screen', false);
                document.getElementById('feedback-screen').classList.remove('hidden');
                if (this.state.health <= 0) setTimeout(() => this.finish(false), 1500);
            },
            resolveLevel() { this.state.health > 0 ? this.nextStep() : this.finish(false); },
            nextStep() { this.state.stepIndex++; this.runStep(); },
            updateHealth(v) {
                this.state.health = Math.max(0, this.state.health + v);
                document.getElementById('health-bar-fill').style.width = this.state.health + "%";
                document.getElementById('health-val').innerText = this.state.health + "%";
            },
            log(msg, type='info') {
                const logs = document.getElementById('system-logs');
                const d = document.createElement('div');
                d.className = `log-entry log-${type}`;
                d.innerText = `> ${msg}`;
                logs.prepend(d);
            },
            finish(isWin) {
                this.hideAllOverlays();
                const scr = document.getElementById('end-screen');
                scr.classList.remove('hidden');
                document.getElementById('end-title').innerText = isWin ? "–ü–û–ë–ï–î–ê" : "–ü–†–û–í–ê–õ";
                document.getElementById('end-title').style.color = isWin ? "var(--neon-green)" : "var(--neon-red)";
                document.getElementById('end-score').innerText = `–°–ß–ï–¢: ${this.state.score}`;
                if(window.Stats) window.Stats.save({
                    date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    user: this.state.user,
                    score: this.state.score,
                    status: isWin ? 'WIN' : 'FAIL'
                });
            },
            hideAllOverlays() { document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden')); },
            toggleScreen(id, show) { const el = document.getElementById(id); show ? el.classList.remove('hidden') : el.classList.add('hidden'); }
        };
    </script>
</body>
</html>
